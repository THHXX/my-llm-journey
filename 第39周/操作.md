# 第39周：向量数据库优化 (Chroma/FAISS → Milvus)

## 1. 目录导航
- [1. 核心目标](#1-核心目标)
- [2. 环境准备](#2-环境准备)
- [3. 性能测试 (100万向量)](#3-性能测试-100万向量)
- [4. 代码迁移 (FAISS -> Milvus)](#4-代码迁移-faiss---milvus)
- [5. 常见问题](#5-常见问题)

## 1. 核心目标
本周我们挑战“百万级”数据检索。
之前的 FAISS (本地文件) 在数据量达到百万级时，内存消耗大且检索速度会变慢。
我们将迁移到 **Milvus** (专业向量数据库)，目标是在 100 万文档中实现 < 100ms 的检索速度。

## 2. 环境准备

### 2.1 启动 Milvus 服务 (Docker)
由于 Windows 下直接运行 Milvus Lite 存在兼容性问题，我们使用 Docker 部署标准版 Milvus。

1. **启动 Docker Desktop** (确保左下角显示绿色 Engine running)。
2. 在 `第39周` 目录下打开终端，运行：
   ```powershell
   docker compose up -d
   ```
3. 检查服务状态：
   ```powershell
   docker compose ps
   ```
   应该看到 `milvus-standalone`, `milvus-minio`, `milvus-etcd` 均为 `Up` 状态。

### 2.2 安装依赖
```powershell
pip install pymilvus langchain langchain-community dashscope
```

## 3. 性能测试 (100万向量)

我们编写了一个基准测试脚本 `100.py`，它会：
1. 向 Milvus 插入 100 万条 768维 的随机向量。
2. 构建 HNSW 高性能索引。
3. 测试检索速度。

**运行测试：**
```powershell
python 100.py
```

**预期结果：**
- 插入可能需要几十秒。
- 索引构建需要几分钟。
- **检索耗时应小于 100ms** (通常在 10ms - 50ms 之间)。

## 4. 代码迁移 (FAISS -> Milvus)

我们将第38周的 `rag_engine.py` 升级为使用 Milvus。

### 主要修改点
1. **引入库**：从 `FAISS` 改为 `Milvus`。
2. **连接配置**：指定 `connection_args={"host": "localhost", "port": "19530"}`。
3. **数据持久化**：Milvus 数据存储在 Docker 容器中，重启容器数据不丢失 (FAISS 是存为本地 `.pkl` 文件)。

### 运行新版 RAG
确保 `data` 目录下有 txt 文件，然后运行：
```powershell
python rag_milvus.py
```

## 5. 常见问题

**Q: 为什么要用 Docker？**
A: Milvus 是云原生时代的数据库，设计之初就是运行在 Linux/K8s 上的。Windows 上虽然有 Lite 版，但对大规模数据支持不好且环境依赖复杂。Docker 是最标准的部署方式。

**Q: 100万数据内存够吗？**
A: 100万条 768维向量 + HNSW 索引大约占用 3-4GB 内存。你的 16GB 电脑完全可以运行。

**Q: 报错 `No module named 'pymilvus'`**
A: 请运行 `pip install pymilvus`。
