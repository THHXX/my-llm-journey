# ç¬¬27å‘¨æ“ä½œæŒ‡å—ï¼šæž„å»ºå¸¦è®°å¿†çš„æ™ºèƒ½ Agent

æœ¬å‘¨æˆ‘ä»¬å°†å®žçŽ°ä¸€ä¸ªèƒ½å¤Ÿâ€œè®°ä½â€ç”¨æˆ·å¯¹è¯ä¸Šä¸‹æ–‡çš„ Agentã€‚

## ðŸŽ¯ ç›®æ ‡
1.  ç†è§£ **Memory (è®°å¿†)** ç»„ä»¶åœ¨ Agent ä¸­çš„ä½œç”¨ã€‚
2.  æŠ›å¼ƒæ—§ç‰ˆ `initialize_agent`ï¼ŒæŽŒæ¡æ–°ç‰ˆ `create_react_agent` å¦‚ä½•é›†æˆè®°å¿†ã€‚
3.  å®žçŽ°å¤šè½®å¯¹è¯ï¼Œè®© Agent è®°ä½ä½ çš„åå­—æˆ–ä¹‹å‰çš„æŒ‡ä»¤ã€‚

---

## ðŸ› ï¸ æ­¥éª¤ 1ï¼šåˆ›å»ºä»£ç æ–‡ä»¶

åœ¨ `ç¬¬27å‘¨` ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º `agent_memory.py` çš„æ–‡ä»¶ï¼Œå¹¶å°†ä¸‹æ–¹ä»£ç å®Œæ•´å¤åˆ¶è¿›åŽ»ã€‚

> **âš ï¸ ä»£ç å‡çº§è¯´æ˜Ž**ï¼š
> ä½ æä¾›çš„ `initialize_agent` åœ¨ LangChain 0.2.x ä¸­å·²æ ‡è®°ä¸ºåºŸå¼ƒã€‚
> ä¸‹æ–¹ä»£ç ä½¿ç”¨äº†å®˜æ–¹æŽ¨èçš„ **`create_react_agent` + `ConversationBufferMemory`** ç»„åˆï¼Œè¿™æ˜¯ç›®å‰æœ€ç¨³å®šã€å¯æ‰©å±•çš„å†™æ³•ã€‚

### ðŸ“„ `agent_memory.py`

```python
import os
from langchain.agents import create_react_agent, AgentExecutor
from langchain_community.llms import Tongyi
from langchain_core.tools import Tool
from langchain_core.prompts import PromptTemplate
from langchain.memory import ConversationBufferMemory

# --- 1. é…ç½® ---
# ç¡®ä¿ DASHSCOPE_API_KEY çŽ¯å¢ƒå˜é‡å·²è®¾ç½®
# os.environ["DASHSCOPE_API_KEY"] = "sk-..."

print(f"{'='*20} åˆå§‹åŒ– Agent (å¸¦è®°å¿†) {'='*20}")

# --- 2. å®šä¹‰å·¥å…· ---
# ä¸ºäº†æ¼”ç¤ºè®°å¿†åŠŸèƒ½ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç®€å•çš„æ¨¡æ‹Ÿå¤©æ°”å·¥å…·
def get_weather(location):
    return f"{location} ä»Šå¤©æ™´æœ—ï¼Œæ°”æ¸© 25 åº¦ã€‚"

tools = [
    Tool(
        name="Weather",
        func=get_weather,
        description="æŸ¥è¯¢å¤©æ°”æ—¶ä½¿ç”¨ã€‚è¾“å…¥ä¸ºåŸŽå¸‚åç§°ã€‚"
    )
]

# --- 3. å®šä¹‰å¸¦è®°å¿†çš„ Prompt ---
# å…³é”®ç‚¹ï¼šæˆ‘ä»¬åœ¨ Prompt ä¸­å¿…é¡»æ˜¾å¼åŠ å…¥ {chat_history} å ä½ç¬¦
template = """Answer the following questions as best you can. You have access to the following tools:

{tools}

Use the following format:

Question: the input question you must answer
Thought: you should always think about what to do
Action: the action to take, should be one of [{tool_names}]
Action Input: the input to the action
Observation: the result of the action
... (this Thought/Action/Action Input/Observation can repeat N times)
Thought: I now know the final answer
Final Answer: the final answer to the original input question

Begin!

Previous conversation history:
{chat_history}

Question: {input}
Thought:{agent_scratchpad}"""

prompt = PromptTemplate.from_template(template)

# --- 4. åˆå§‹åŒ– LLM å’Œ Memory ---
llm = Tongyi(model="qwen-max")

# memory_key="chat_history" å¿…é¡»ä¸Ž Prompt ä¸­çš„ {chat_history} å¯¹åº”
memory = ConversationBufferMemory(memory_key="chat_history")

# --- 5. åˆ›å»º Agent æ‰§è¡Œå™¨ ---
agent = create_react_agent(llm, tools, prompt)

# å°† memory ä¼ å…¥ AgentExecutor
agent_executor = AgentExecutor(
    agent=agent, 
    tools=tools, 
    memory=memory, 
    verbose=True,
    handle_parsing_errors=True
)

# --- 6. è¿è¡Œå¤šè½®å¯¹è¯ ---
print("\nðŸ¤– [ç¬¬ä¸€è½®] å‘Šè¯‰ Agent æˆ‘çš„åå­—...")
agent_executor.invoke({"input": "ä½ å¥½ï¼Œæˆ‘æ˜¯å°æ˜Žã€‚"})

print("\nðŸ¤– [ç¬¬äºŒè½®] è¯¢é—® Agent æ˜¯å¦è®°å¾—æˆ‘...")
# è¿™é‡Œæˆ‘ä»¬å¹¶æ²¡æœ‰åœ¨ input ä¸­æåå­—ï¼ŒAgent å¿…é¡»ä»Ž memory ä¸­èŽ·å–
response = agent_executor.invoke({"input": "æˆ‘åˆšæ‰è¯´æˆ‘å«ä»€ä¹ˆåå­—ï¼Ÿ"})

print(f"\nâœ… æœ€ç»ˆå›žå¤: {response['output']}")

print("\nðŸ¤– [ç¬¬ä¸‰è½®] ç»“åˆå·¥å…·ä½¿ç”¨...")
agent_executor.invoke({"input": "æˆ‘çŽ°åœ¨åœ¨åŒ—äº¬ï¼Œè¿™é‡Œå¤©æ°”æ€Žä¹ˆæ ·ï¼Ÿ"})
```

---

## ðŸš€ æ­¥éª¤ 2ï¼šè¿è¡Œä¸ŽéªŒè¯

1.  æ‰“å¼€ç»ˆç«¯ (Terminal)ã€‚
2.  è¿›å…¥ç¬¬27å‘¨ç›®å½•ï¼ˆå¦‚æžœè¿˜æ²¡è¿›å…¥ï¼‰ï¼š
    ```powershell
    cd F:\Desktop\ä¸ªäººèµ„æ–™\å¤§æ¨¡åž‹å­¦ä¹ é¡¹ç›®\ç¬¬27å‘¨
    ```
3.  è¿è¡Œè„šæœ¬ï¼š
    ```powershell
    python agent_memory.py
    ```

### âœ… é¢„æœŸè¾“å‡ºç»“æžœ

ä½ éœ€è¦è§‚å¯Ÿç»ˆç«¯æ—¥å¿—ï¼Œç¡®è®¤ä»¥ä¸‹å‡ ç‚¹ï¼š

1.  **ç¬¬ä¸€è½®**ï¼šAgent å›žå¤ç¡®è®¤æ”¶åˆ°ï¼ˆä¾‹å¦‚ï¼šâ€œä½ å¥½å°æ˜Ž...â€ï¼‰ã€‚
2.  **ç¬¬äºŒè½®**ï¼š
    *   **å…³é”®ç‚¹**ï¼šPrompt ä¸­çš„ `Previous conversation history` éƒ¨åˆ†åº”è¯¥ä¼šæ˜¾ç¤º `Human: ä½ å¥½ï¼Œæˆ‘æ˜¯å°æ˜Žã€‚`
    *   Agent å›žå¤ï¼šâ€œä½ åˆšæ‰è¯´ä½ å«å°æ˜Žã€‚â€
3.  **ç¬¬ä¸‰è½®**ï¼šAgent è°ƒç”¨ `Weather` å·¥å…·æŸ¥è¯¢åŒ—äº¬å¤©æ°”ï¼Œè¯´æ˜Žè®°å¿†åŠŸèƒ½ä¸å½±å“å·¥å…·è°ƒç”¨ã€‚

---

## ðŸ§  æ ¸å¿ƒåŽŸç†è§£æž

### ä¸ºä»€ä¹ˆéœ€è¦ `chat_history`ï¼Ÿ

LLM æœ¬èº«æ˜¯**æ— çŠ¶æ€**çš„ï¼ˆStatelessï¼‰ã€‚ä½ å‘ç»™å®ƒçš„æ¯ä¸€æ¬¡è¯·æ±‚ï¼Œå¯¹å®ƒæ¥è¯´éƒ½æ˜¯å…¨æ–°çš„ã€‚

*   **æ²¡æœ‰ Memory**ï¼š
    *   ä½ ï¼šâ€œæˆ‘æ˜¯å°æ˜Žâ€ -> LLMï¼šâ€œä½ å¥½å°æ˜Žâ€
    *   ä½ ï¼šâ€œæˆ‘æ˜¯è°ï¼Ÿâ€ -> LLMï¼šâ€œæˆ‘ä¸çŸ¥é“ï¼Œä½ æ²¡å‘Šè¯‰æˆ‘ã€‚â€
*   **æœ‰ Memory**ï¼š
    *   `AgentExecutor` ä¼šè‡ªåŠ¨å¸®ä½ æŠŠä¹‹å‰çš„å¯¹è¯è®°å½•å­˜èµ·æ¥ã€‚
    *   å½“ä½ é—®â€œæˆ‘æ˜¯è°â€æ—¶ï¼Œå®ƒä¼šæŠŠ **[ä¹‹å‰çš„å¯¹è¯ + ä½ çš„æ–°é—®é¢˜]** æ‰“åŒ…ä¸€èµ·å‘ç»™ LLMã€‚
    *   LLM çœ‹åˆ°è®°å½•é‡Œæœ‰â€œæˆ‘æ˜¯å°æ˜Žâ€ï¼ŒäºŽæ˜¯å°±èƒ½å›žç­”ä½ ã€‚

### ä»£ç ä¸­çš„å…³é”®æ˜ å°„

```mermaid
graph LR
    A[Memoryç»„ä»¶] -- memory_key="chat_history" --> B(AgentExecutor)
    B -- è‡ªåŠ¨æ³¨å…¥ --> C[Promptæ¨¡æ¿ä¸­çš„ {chat_history}]
    C -- å®Œæ•´ä¸Šä¸‹æ–‡ --> D[LLM å¤§è„‘]
```