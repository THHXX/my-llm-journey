# 第26周：构建智能 Agent (调用工具) - 操作指南

本周目标是让大模型学会“使用工具”。我们将实现一个 Agent，它可以根据你的问题，自动决定是去查天气，还是去搜索网络。

## 📂 目录
- [1. 环境准备](#1-环境准备)
- [2. 代码实战](#2-代码实战)
- [3. 运行与验证](#3-运行与验证)
- [4. 进阶：如何使用真实搜索 (SerpApi)](#4-进阶如何使用真实搜索-serpapi)

---

## 1. 环境准备

我们需要安装 Google 搜索组件（即使使用模拟数据，保持环境完整性也是好的习惯）。

```powershell
pip install google-search-results
```

---

## 2. 代码实战

我已为您创建了 `agent_demo.py`。为了确保您能直接运行成功，我提供了**两套方案**：

1.  **默认方案 (无需 Key)**：使用我预定义的“模拟天气工具”，无需注册任何额外账号。
2.  **进阶方案 (需 Key)**：如果您配置了 `SERPAPI_API_KEY`，Agent 会自动获得 Google 搜索能力。

### 代码详解

```python
from langchain.agents import create_react_agent, AgentExecutor
from langchain_community.llms import Tongyi
from langchain_core.tools import Tool
from langchain_core.prompts import PromptTemplate
import os

# 1. 定义工具：告诉 Agent 这个工具是干嘛的
def get_weather(location):
    # 这里我们模拟查询，实际项目中可以替换为真实 API
    if "北京" in location:
        return "北京今天晴朗，气温 15-25 度。"
    return "未知城市"

weather_tool = Tool(
    name="WeatherQuery",
    func=get_weather,
    description="当用户询问天气时使用此工具。"
)

tools = [weather_tool]

# 2. 初始化大脑
llm = Tongyi(model="qwen-max")

# 3. 定义思考模板 (ReAct 模式)
# 这是一个标准的 Prompt，教模型：思考 -> 行动 -> 观察 -> 思考...
template = """Answer the following questions as best you can. You have access to the following tools:
{tools}
Use the following format:
Question: the input question you must answer
Thought: you should always think about what to do
Action: the action to take, should be one of [{tool_names}]
Action Input: the input to the action
Observation: the result of the action
...
Final Answer: the final answer
Begin!
Question: {input}
Thought:{agent_scratchpad}"""
prompt = PromptTemplate.from_template(template)

# 4. 创建 Agent
agent = create_react_agent(llm, tools, prompt)
agent_executor = AgentExecutor(agent=agent, tools=tools, verbose=True)

# 5. 运行
agent_executor.invoke({"input": "北京今天的天气怎么样？"})
```

---

## 3. 运行与验证

### 运行基础 Demo (无网)
```powershell
python 第26周/agent_demo.py
```

### 运行联网 Agent (本次任务核心)
```powershell
python 第26周/agent_search.py
```
*(注：如果不开启 VPN，此步可能会失败。失败请看下方解决方案)*

---

## 4. 常见问题与解决方案 (FAQ)

### Q1: 运行报错 `DuckDuckGoSearch... return None` 或 `ConnectTimeout`？
**原因**：DuckDuckGo 是国外引擎，在国内被阻断，且对 IP 要求很高。
**解决方案**：
1.  **开启 VPN**：必须开启，且建议使用“全局模式”。
2.  **使用 SerpApi (推荐)**：见下文“国内搜索方案”。

### Q2: 有没有中国的搜索 API？
**有！** 针对国内开发者，推荐以下方案：

| API 名称 | 适用场景 | 是否免费 | 稳定性 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| **SerpApi (百度引擎)** | 通用搜索 | ❌ (有免费额度) | ⭐⭐⭐⭐⭐ (最稳) | LangChain 原生支持，推荐！ |
| **Bocha (博查)** | AI 搜索专用 | ❌ (有免费额度) | ⭐⭐⭐⭐⭐ (国产) | 专为 AI 优化，效果极好 |

### Q3: 这个模型不是阿里的吗？
**是**。我们使用的是 `Tongyi` (通义千问)，这是阿里巴巴 Qwen 系列的大模型。

---

## 5. 进阶：使用 SerpApi (国内稳妥方案)

如果您希望一劳永逸地解决搜索问题，请使用 `agent_search_serpapi.py`。

1.  注册 [SerpApi](https://serpapi.com/) 获取 Key。
2.  运行代码：
    ```powershell
    # Windows 设置 Key
    $env:SERPAPI_API_KEY="您的Key"
    
    # 运行
    python 第26周/agent_search_serpapi.py
    ```
    打开文件，找到第 11 行：
    ```python
    os.environ["SERPAPI_API_KEY"] = "您的_SERPAPI_KEY_粘贴在这里"
    ```
4.  **运行**：
    ```powershell
    python 第26周/agent_search_serpapi.py
    ```

### 预期输出
您会看到 Agent 的思考过程（Thinking Process）：

```text
> Entering new AgentExecutor chain...
Thought: 用户想知道北京的天气，我应该使用 WeatherQuery 工具。
Action: WeatherQuery
Action Input: 北京
Observation: 北京今天晴朗，气温 15-25 度，适合出行。
Thought: 我已经获取了天气信息，可以回答用户了。
Final Answer: 北京今天晴朗，气温 15-25 度，适合出行。

> Finished chain.
```

---

## 4. 进阶：如何使用真实搜索 (SerpApi)

如果您希望 Agent 真的能去 Google 搜索（例如问它“昨天发生了什么大新闻”），需要配置 SerpApi。

1.  **注册**：访问 [SerpApi 官网](https://serpapi.com/) 注册账号（有免费额度）。
2.  **获取 Key**：在仪表盘找到您的 API Key。
3.  **配置**：
    在终端执行：
    ```powershell
    $env:SERPAPI_API_KEY="您的_key_xxxxxxxx"
    ```
4.  **运行**：再次运行 `agent_demo.py`，代码会自动检测到 Key 并启用搜索工具。

---

## 5. 补充：关于搜索 API 的选择 (常见问题)

您之前遇到的 `duckduckgo_search` 错误通常是因为网络连接问题（国内访问受限）。针对国内环境，我推荐以下方案：

### 1. 方案对比

| API 名称 | 费用 | 稳定性 (国内) | 需要 Key | 推荐指数 | 备注 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **DuckDuckGo** | 免费 | ❌ 低 | 否 | ⭐ | 需科学上网，常被阻断 |
| **SerpApi (百度)** | 收费 (有免费额度) | ✅ 高 | 是 | ⭐⭐⭐⭐⭐ | LangChain 原生支持，可切换 Google/Baidu |
| **Bocha (博查)** | 收费 (有免费额度) | ✅ 高 | 是 | ⭐⭐⭐⭐ | 专为 AI 设计的国产搜索 API |
| **Tavily** | 收费 (有免费额度) | ✅ 中 | 是 | ⭐⭐⭐ | 适合 Agent，主要英文源，但可用 |

### 2. 推荐方案

根据您的网络环境选择最简单的方法：

#### 🅰️ 方案 A：我有科学上网工具 (VPN) ✅ **最简单！推荐！**
不需要申请任何 Key，直接使用免费的 DuckDuckGo。

1.  **开启 VPN**：确保您的 VPN 已开启（建议开启全局模式或 TUN 模式）。
2.  **运行代码**：
    ```powershell
    python 第26周/agent_search.py
    ```
    *(注：我已优化此文件，会自动检测您的网络连接)*

#### 🅱️ 方案 B：由于网络限制无法访问外网
使用 SerpApi（支持百度），需要注册账号。

1.  **注册**：访问 [SerpApi 官网](https://serpapi.com/) 注册。
2.  **获取 Key**：复制您的 Private API Key。
3.  **运行代码**：
    ```powershell
    # 先设置 Key (Windows)
    $env:SERPAPI_API_KEY="您的Key粘贴在这里"
    python 第26周/agent_search_serpapi.py
    ```
    打开文件，找到第 11 行：
    ```python
    os.environ["SERPAPI_API_KEY"] = "您的_SERPAPI_KEY_粘贴在这里"
    ```
4.  **运行**：
    ```powershell
    python 第26周/agent_search_serpapi.py
    ```

### 3. 常见问题解答

*   **Q: 这个模型不是阿里的吗？**
    *   **A:** 是的，`Tongyi` (通义千问) 是阿里巴巴的大模型。我们通过 `langchain_community.llms.Tongyi` 调用它。
*   **Q: SERPAPI_API_KEY 和 真实搜索 (SerpApi)，这两个API都需要吗？**
    *   **A:** 不需要两个。`SerpApi` 是一个服务商的名字，`SERPAPI_API_KEY` 是使用这个服务所需的密码。有了这个 Key，您就可以使用 Google、Baidu 等多种搜索引擎。
*   **Q: 有没有中国的搜索API？**
    *   **A:** 有。
        *   **直接方案**：使用 **SerpApi** 并设置参数 `engine="baidu"`（如上文代码所示）。
        *   **国产方案**：**博查 (Bocha)** 是目前国内专门做 AI 搜索最好的之一，但在 LangChain 中集成需要稍微多写几行代码（如有需要我可以为您演示）。

---

## 💡 核心原理 (First Principles)
**Agent 是什么？**
Agent = **LLM (大脑)** + **Tools (手脚)** + **Planning (规划能力)**。

大模型本身不能联网，也不知道实时天气。但当我们告诉它：“你有一个叫 `WeatherQuery` 的工具，输入城市名就能查天气”，聪明的 LLM 就会在遇到天气问题时，**决定**去调用这个工具，而不是自己瞎编。这就是 Agent 的本质。