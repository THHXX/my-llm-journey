import json
import numpy as np
from sentence_transformers import SentenceTransformer

class LawRAG:
    def __init__(self, json_path):
        print("ğŸ“¥ æ­£åœ¨åŠ è½½çŸ¥è¯†åº“...")
        with open(json_path, 'r', encoding='utf-8') as f:
            self.knowledge = json.load(f)
        
        # æå–æ‰€æœ‰æ–‡æœ¬
        self.corpus = [item['content'] for item in self.knowledge]
        
        print("ğŸ§  æ­£åœ¨åŠ è½½æ£€ç´¢æ¨¡å‹ (moka-ai/m3e-small)...")
        # ä½¿ç”¨ä¸­æ–‡æ•ˆæœå¾ˆå¥½çš„è½»é‡çº§åµŒå…¥æ¨¡å‹
        self.encoder = SentenceTransformer(r'C:\Users\JYJYJ\.cache\huggingface\hub\models--moka-ai--m3e-small\snapshots\44c696631b2a8c200220aaaad5f987f096e986df')
        
        print("âš¡ æ­£åœ¨æ„å»ºå‘é‡ç´¢å¼•...")
        self.corpus_embeddings = self.encoder.encode(self.corpus)

    def search(self, query, top_k=2):
        # 1. æŠŠç”¨æˆ·çš„é—®é¢˜å˜æˆå‘é‡
        query_embedding = self.encoder.encode(query)
        
        # 2. è®¡ç®—ç›¸ä¼¼åº¦ (Cosine Similarity)
        # ç®€å•çš„ç‚¹ç§¯è®¡ç®—
        similarities = np.dot(self.corpus_embeddings, query_embedding)
        
        # 3. æ‰¾å‡ºæœ€ç›¸ä¼¼çš„ top_k ä¸ª
        top_indices = np.argsort(similarities)[-top_k:][::-1]
        
        results = []
        for idx in top_indices:
            results.append(self.corpus[idx])
            
        return results
